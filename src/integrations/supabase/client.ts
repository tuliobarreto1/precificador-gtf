
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://pvsjjqmsoauuxxfgdhfg.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2c2pqcW1zb2F1dXh4ZmdkaGZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMxMTI5NTUsImV4cCI6MjA1ODY4ODk1NX0.Mp6zyYRkHfHZTkBIkV_lpYv8nkAkJ9i7cI1y8dGGF6M";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    storage: typeof localStorage !== 'undefined' ? localStorage : undefined,
    persistSession: true,
    autoRefreshToken: true
  }
});

// Fun√ß√£o para verificar a conex√£o com o Supabase
export async function checkSupabaseConnection() {
  try {
    console.log('Verificando conex√£o com o Supabase...');
    const { data, error } = await supabase.from('vehicle_groups').select('id').limit(1);
    
    if (error) {
      console.error('Erro ao conectar ao Supabase:', error);
      throw error;
    }
    
    console.log('Conex√£o com o Supabase estabelecida com sucesso:', data);
    return { success: true, data };
  } catch (error) {
    console.error('Erro ao conectar ao Supabase:', error);
    return { success: false, error };
  }
}

// Fun√ß√£o para salvar or√ßamento no Supabase
export async function saveQuoteToSupabase(quote: any) {
  try {
    console.log('üîç Detalhando dados do or√ßamento para salvar:', {
      clientId: quote.clientId,
      contractMonths: quote.contractMonths,
      monthlyKm: quote.monthlyKm,
      operationSeverity: quote.operationSeverity || 3,
      hasTracking: quote.hasTracking || false,
      totalCost: quote.totalCost || 0,
      id: quote.id || 'novo',
      veiculos: quote.vehicles?.length || 0
    });
    
    // Verifica se o or√ßamento j√° tem id (atualiza√ß√£o) ou √© um novo
    if (quote.id) {
      // Atualizar or√ßamento existente
      console.log(`Atualizando or√ßamento existente com ID ${quote.id}`);
      const { data, error } = await supabase
        .from('quotes')
        .update({
          client_id: quote.clientId,
          contract_months: quote.contractMonths,
          monthly_km: quote.monthlyKm,
          operation_severity: quote.operationSeverity,
          has_tracking: quote.hasTracking,
          total_value: quote.totalCost || 0,
          status: 'active',
          title: `Or√ßamento ${new Date().toLocaleDateString('pt-BR')}`
        })
        .eq('id', quote.id)
        .select();
      
      if (error) {
        console.error('‚ùå Erro ao atualizar or√ßamento no Supabase:', error);
        return { success: false, error };
      }
      
      console.log('‚úÖ Or√ßamento atualizado com sucesso:', data);
      return { success: true, data };
    } else {
      // Criar novo or√ßamento
      console.log('Inserindo novo or√ßamento no Supabase');
      const { data, error } = await supabase
        .from('quotes')
        .insert({
          client_id: quote.clientId,
          contract_months: quote.contractMonths,
          monthly_km: quote.monthlyKm,
          operation_severity: quote.operationSeverity || 3,
          has_tracking: quote.hasTracking || false,
          total_value: quote.totalCost || 0,
          status: 'active',
          title: `Or√ßamento ${new Date().toLocaleDateString('pt-BR')}`
        })
        .select();
      
      if (error) {
        console.error('‚ùå Erro ao inserir or√ßamento no Supabase:', error);
        console.error('Detalhes do erro:', error.details, error.message, error.hint);
        return { success: false, error };
      }
      
      console.log('‚úÖ Or√ßamento salvo com sucesso:', data);
      
      if (data && data[0] && quote.vehicles && quote.vehicles.length > 0) {
        // Salvar os itens do or√ßamento
        const quoteId = data[0].id;
        console.log(`Salvando ${quote.vehicles.length} ve√≠culos para o or√ßamento ${quoteId}`);
        
        // Preparar os itens para inser√ß√£o
        const quoteItems = quote.vehicles.map((item: any) => ({
          quote_id: quoteId,
          vehicle_id: item.vehicle.id,
          monthly_value: item.totalCost || 0,
          contract_months: quote.contractMonths,
          monthly_km: quote.monthlyKm,
          operation_severity: quote.operationSeverity || 3,
          has_tracking: quote.hasTracking || false
        }));
        
        console.log('Itens do or√ßamento a serem inseridos:', quoteItems);
        
        const { error: itemsError } = await supabase
          .from('quote_items')
          .insert(quoteItems);
          
        if (itemsError) {
          console.error('‚ùå Erro ao inserir itens do or√ßamento:', itemsError);
          console.error('Detalhes do erro:', itemsError.details, itemsError.message, itemsError.hint);
          // N√£o falharemos todo o processo se apenas os itens falharem
        } else {
          console.log('‚úÖ Itens do or√ßamento salvos com sucesso');
        }
      }
      
      return { success: true, data };
    }
  } catch (error) {
    console.error('‚ùå Erro inesperado ao salvar or√ßamento:', error);
    return { success: false, error };
  }
}

// Fun√ß√£o para buscar or√ßamentos no Supabase
export async function getQuotesFromSupabase() {
  try {
    console.log('Buscando or√ßamentos no Supabase...');
    
    // Buscar or√ßamentos com relacionamentos
    const { data, error } = await supabase
      .from('quotes')
      .select(`
        *,
        client:client_id(*),
        items:quote_items(
          *,
          vehicle:vehicle_id(*)
        )
      `)
      .order('created_at', { ascending: false });
    
    if (error) {
      console.error('Erro ao buscar or√ßamentos no Supabase:', error);
      return { success: false, error, quotes: [] };
    }
    
    console.log(`Encontrados ${data?.length || 0} or√ßamentos no Supabase`);
    if (data && data.length > 0) {
      console.log('Primeiro or√ßamento:', data[0]);
    }
    
    return { success: true, quotes: data || [] };
    
  } catch (error) {
    console.error('Erro inesperado ao buscar or√ßamentos:', error);
    return { success: false, error, quotes: [] };
  }
}

// Fun√ß√£o para buscar um √∫nico or√ßamento pelo ID
export async function getQuoteByIdFromSupabase(quoteId: string) {
  try {
    console.log(`Buscando or√ßamento com ID ${quoteId} no Supabase...`);
    
    const { data, error } = await supabase
      .from('quotes')
      .select(`
        *,
        client:client_id(*),
        items:quote_items(
          *,
          vehicle:vehicle_id(*)
        )
      `)
      .eq('id', quoteId)
      .single();
    
    if (error) {
      console.error(`Erro ao buscar or√ßamento com ID ${quoteId}:`, error);
      return { success: false, error };
    }
    
    console.log('Or√ßamento encontrado:', data);
    return { success: true, quote: data };
    
  } catch (error) {
    console.error('Erro inesperado ao buscar or√ßamento por ID:', error);
    return { success: false, error };
  }
}
